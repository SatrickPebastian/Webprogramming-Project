<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <link rel="icon" href="images/resourceImages/hai23.png">

        <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
        <script src="bootstrap/js/bootstrap.min.js"></script>
        <script src="javaScript/jquery-2.1.4.min.js"></script>

        <!-- Sweet alert import -->
        <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>

        <!-- jQuery -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        

        

        
        
        <!--<link href="bootstrap/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
        <script src="bootstrap/js/bootstrap.min.js"></script>
        <script src="javascript/jquery-2.1.4.min.js"></script>-->
        <title>Sign Up</title>
    </head>
    <body>
    
    <header>
        
    </header>
        <div class="container">    
            <div id="loginbox" style="margin-top:50px;" class="mainbox col-md-6 col-md-offset-3 col-sm-8 col-sm-offset-2">                    
                <div class="panel panel-info" >
                    <div class="panel-heading">
                        <div class="panel-title">
                            Registrieren
                        </div>
                        <div style="float:right; font-size: 80%; position: relative; top:-10px">
                            <a href="login.html">
                                Sie haben bereits einen Account?
                            </a>
                        </div>
                    </div>  

                    <div class="panel-body" >
                        <form id="signupform" class="form-horizontal" role="form" method="POST" action="php/signup.php" autocomplete="off">
                            <div id="signupalert" style="display:none" class="alert alert-danger">
                                <p>Error:</p>
                                <span></span>
                            </div>          
                            <div class="form-group" style="margin-bottom: 30px;">
                                <label for="txt_vorname" class="col-md-3 control-label">Vorname</label>
                                <div class="col-md-9">
                                    <input id="txt_vorname" name="txt_vorname" placeholder="Vorname" class="form-control" required type="text" autocomplete="new-password">
                                </div>
                            </div>
                            <div class="form-group" style="margin-bottom: 30px;">
                                <label for="txt_nachname" class="col-md-3 control-label">Nachname</label>
                                <div class="col-md-9">
                                    <input id="txt_nachname" name="txt_nachname" placeholder="Nachname" class="form-control" required type="text" autocomplete="new-password">
                                </div>
                            </div>
                            <div class="form-group" style="margin-bottom: 30px;">
                                <label for="txt_username" class="col-md-3 control-label">Username</label>
                                <div class="col-md-9">
                                    <small id="usernameError" style="color:red; position:absolute; bottom:33px; left:205px;"></small>
                                    <input id="txt_username" name="txt_username" placeholder="Username" class="form-control" required type="text" autocomplete="new-password">
                                </div>
                            </div>
                            <div class="form-group" style="margin-bottom: 30px;">
                                <label for="txt_email" class="col-md-3 control-label">Email</label>
                                <div class="col-md-9">
                                    <small id="emailError" style="color:red; position:absolute; bottom:33px; left:225px;"></small>
                                    <input id="txt_email" name="txt_email" placeholder="Email" class="form-control" required type="email" autocomplete="new-password">
                                </div>
                            </div>
                            <div class="form-group" style="margin-bottom: 30px;">
                                <label for="txt_straße" class="col-md-3 control-label">Straße</label>
                                <div class="col-md-9">
                                    <input id="txt_straße" name="txt_straße" placeholder="Straße" class="form-control" required type="text" autocomplete="new-password">
                                </div>
                            </div>
                            <div class="form-group" style="margin-bottom: 30px;">
                                <label for="txt_plz" class="col-md-3 control-label">PLZ</label>
                                <div class="col-md-9">
                                    <small id="plzError" style="color:red; position:absolute; bottom:33px; left:200px;"></small>
                                    <input id="txt_plz" name="txt_plz" placeholder="PLZ" class="form-control" required type="text" autocomplete="new-password">
                                </div>
                            </div>
                            <div class="form-group" style="margin-bottom: 30px;">
                                <label for="txt_stadt" class="col-md-3 control-label">Stadt</label>
                                <div class="col-md-9">
                                    <small id="stadtError" style="color:red; position:absolute; bottom:33px; left:191px;"></small>
                                    <input id="txt_stadt" name="txt_stadt" placeholder="Stadt" class="form-control" required type="text">
                                </div>
                            </div>
                            
                            
                            <div class="form-group">                                        
                                <div class="col-md-offset-3 col-md-9">
                                    <button id="button1_save" name="button1_save" class="btn btn-success" type="submit">Registrieren</button>
                                    <button type="reset" id="button2_cancel" name="button2_cancel" class="btn btn-inverse">Abbrechen</button>
                                </div>
                            </div>  
                        </form>
                    </div> 
                    <div id="errorMessage" style="color:red; margin:7px;"></div>                   
                </div>  
            </div>  
        </div>

        <script type="text/javascript">

            const firstname = document.getElementById('txt_vorname');
            const lastname = document.getElementById('txt_nachname');
            
            
            const straße = document.getElementById('txt_straße');
            const plz = document.getElementById('txt_plz');
            const stadt = document.getElementById('txt_stadt');

            const errorElement = document.getElementById('errorMessage');

            const form = document.getElementById('signupform');

            let messages = [];

            let usernameCheckDb = false;
            let emailCheckDb = false;
            var plzCheck = false;
            let stadtCheck = false;

            


            $(document).ready(function(){

                //Mit AJAX überprüfen ob E-Mail bereits registriert wurde.
               $('#txt_email').blur(function(){

                let email = $('#txt_email').val();
                $('#txt_email').css('border', '');
                $('#emailError').html("");

                $.ajax({
                    method: "post",
                    url: "php/checkEmail.php",
                    data: {
                        'email' : email
                    },
                    dataType: "json",
                    success: function(daten){

                        if(daten === true){
                            emailCheckDb = true;
                        }else {
                            emailCheckDb = false;

                            $('#txt_email').css('border', 'solid #FF0000');
                            $('#emailError').html("E-Mail ist bereits registriert.");
                        }
                    },
                    error: function(daten){
                        console.log("etwas ist schiefgelaufen.");
                    }
                });
               });
               

               //Mit AJAX überprüfen ob Username bereits registriert wurde.
               $('#txt_username').blur(function(){

                let username = $('#txt_username').val();
                $('#txt_username').css('border', '');
                $('#usernameError').html("");

                $.ajax({
                    method: "post",
                    url: "php/checkUsername.php",
                    data: {
                        'username' : username
                    },
                    dataType: "json",
                    success: function(daten){

                        if(daten === true){
                            usernameCheckDb = true;
                        }else {
                            usernameCheckDb = false;

                            $('#txt_username').css('border', 'solid #FF0000');
                            $('#usernameError').html("Username ist bereits vergeben.");
                        }
                    },
                    error: function(daten){
                        console.log("etwas ist schiefgelaufen.");
                    }
                });
                });


                //Überprüfen ob PLZ gültig ist (genauer: ob PLZ eine Zahl ist)
                $('#txt_plz').blur(function(){

                    let plz = $('#txt_plz').val();
                    $('#plzError').html("");
                    $('#txt_plz').css('border', '');

                    if(isNaN(plz)){
                        $('#plzError').html("Bitte eine gültige PLZ eingeben.");
                        $('#txt_plz').css('border', 'solid #FF0000');
                    }else {
                        plzCheck = true;
                    }
                });


                //Überprüfen ob Stadt gültig ist (genauer: ob Stadt aus Buchstaben besteht)
                $('#txt_stadt').blur(function(){

                    let stadt = $('#txt_stadt').val();
                    $('#stadtError').html("");
                    $('#txt_stadt').css('border', '');

                    if(!isNaN(stadt)){
                        
                        $('#stadtError').html("Bitte eine gültige Eingabe tätigen.");
                        $('#txt_stadt').css('border', 'solid #FF0000');
                    }else {
                        console.log('klappt');
                        console.log(stadtCheck);
                        stadtCheck = true;
                        console.log(stadtCheck);
                    }
                });



                $('#signupform').submit(function(e){
                    e.preventDefault();

                    if(usernameCheckDb == false){
                        messages.push('Username ist bereits vergeben.');
                    }

                    if(emailCheckDb == false){
                        messages.push('E-Mail Addresse ist bereits registriert.');
                    }

                    if(plzCheck == false){
                        messages.push('Bitte gültige PLZ eingeben.');
                    }

                    if(stadtCheck == false){
                        messages.push("Bitte gültige Stadt eingeben.");
                    }


                    if(messages.length > 0){
                        swal({
                            title: "Fehler",
                            icon: "error",
                            text: messages.join('\n')
                        });
                        messages = [];
                    }else {

                        $.ajax({
                        method: "post",
                        url: "php/signup.php",
                        data: {
                            'txt_vorname' : $('#txt_vorname').val(),
                            'txt_nachname' : $('#txt_nachname').val(),
                            'txt_username' : $('#txt_username').val(),
                            'txt_email' : $('#txt_email').val(),
                            'txt_stadt' : $('#txt_stadt').val(),
                            'txt_plz' : $('#txt_plz').val(),
                            'txt_straße' : $('#txt_straße').val()
                        },
                        dataType: "json",
                        success: function(response) {
                            console.log(response);
                        }
                        });

                        swal({
                        title: "Registrierung erfolgreich",
                        icon: "success",
                        text: "Sie haben eine E-Mail mit Ihrem Passwort erhalten."
                        
                        }).then(function(){
                            window.location = "login.html";
                        });
                    }
                });

                $('#button2_cancel').click(function(e){
                    window.location = 'php/startpage.php';
                });
            });

            //Funktion um auch den Autofill des Browsers als Change-Event zu registrieren.
            $.fn.allchange = function (callback){
                var me = this;
                var last = "";
                var infunc = function() {
                    var text = $(me).val();
                    if(text != last){
                        last = text;
                        callback();
                    }
                    setTimeout(infunc, 100);
                }
                setTimeout(infunc, 100);
            }

          </script>
    </body>
</htlm>